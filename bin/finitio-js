#!/usr/bin/env node

const fs = require('fs');
const program = require('commander');

const Finitio = require('../lib/finitio').default;

program.version('finitio.js ' + Finitio.VERSION + ' (c) Bernard, Louis Lambeau & the University of Louvain').usage('[options] SCHEMA.fio [DATA.json]').option('-b, --bundle', 'Bundle the input schema as a javascript loader').option('--url [url]', 'Specify the bundle global url').option('-v, --validate', 'Valid input data against the schema').option('-f, --fast', 'Stop on first validation error').option('--no-check', 'Do not try to check the system before bundling').option('--stack', 'Show stack trace on error').parse(process.argv);

const sourceUrl = function() {
  if (typeof program.url === 'string') {
    return program.url;
  } else {
    return 'file://' + program.args[0];
  }
};

const schemaFile = function() {
  return program.args[0];
};

const schemaSource = function() {
  return fs.readFileSync(schemaFile).toString();
};

const world = function() {
  const w = {
    sourceUrl: sourceUrl(),
    failfast: program.fast
  };
  if (program.check) {
    w.check = true;
  }
  return w;
};

const schema = function() {
  return Finitio.system(schemaSource(), world());
};

const data = function() {
  const dataFile = program.args[1];
  const dataSource = fs.readFileSync(dataFile).toString();
  return JSON.parse(dataSource);
};

const strategies = [];

const errorManager = function(e) {
  const results = [];
  for (let i = 0, len = strategies.length; i < len; i++) {
    const s = strategies[i];
    if (s[0](e)) {
      s[1](e);
      break;
    } else {
      results.push(void 0);
    }
  }
  return results;
};

strategies.push([
  function(e) {
    return e instanceof Finitio.TypeError;
  }, function(e) {
    if (program.stack) {
      return console.log(e.explainTree());
    } else {
      return console.log(e.explain());
    }
  }
]);

strategies.push([
  function(e) {
    return e.name === 'SyntaxError';
  }, function(e) {
    console.log('[' + e.line + ':' + e.column + '] ' + e.message);
    if (program.stack) {
      return console.log(e.expected);
    }
  }
]);

strategies.push([
  function(e) {
    return true;
  }, function(e) {
    console.log(e.message);
    if (program.stack) {
      return console.log(e.stack);
    }
  }
]);

const actions = {};

actions.bundle = function() {
  return console.log(Finitio.bundleFile(schemaFile(), world()));
};

actions.validate = function() {
  return console.log(schema().dress(data(), world()));
};

try {
  let action;
  if (program.bundle) {
    action = actions.bundle;
  } else if (program.validate) {
    action = actions.validate;
  }
  if (action != null) {
    action();
  } else {
    program.outputHelp();
  }
} catch (error) {
  const e = error;
  errorManager(e);
}

